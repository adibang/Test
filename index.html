<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Barcode POS Printer - Simple & Effective</title>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .container {
      width: 100%;
      max-width: 400px;
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 25px;
    }

    .header h1 {
      color: #2c3e50;
      font-size: 24px;
      margin-bottom: 5px;
    }

    .header p {
      color: #7f8c8d;
      font-size: 14px;
    }

    .input-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group:last-child {
      margin-bottom: 0;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      color: #2c3e50;
      font-weight: 600;
      font-size: 14px;
    }

    .input-group input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
      text-align: center;
      font-family: 'Courier New', monospace;
    }

    .input-group input:focus {
      outline: none;
      border-color: #3498db;
    }

    .control-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .btn {
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .btn-success {
      background: #2ecc71;
      color: white;
    }

    .btn-success:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .btn-warning {
      background: #f39c12;
      color: white;
    }

    .btn-warning:hover {
      background: #d35400;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .print-btn {
      width: 100%;
      padding: 16px;
      background: #2c3e50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .print-btn:hover {
      background: #1a252f;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .print-btn:active {
      transform: translateY(0);
    }

    .preview-section {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
    }

    .preview-title {
      text-align: center;
      margin-bottom: 15px;
      color: #2c3e50;
      font-weight: 600;
    }

    .barcode-preview {
      margin-bottom: 15px;
      text-align: center;
    }

    .barcode-preview:last-child {
      margin-bottom: 0;
    }

    .barcode-label {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 5px;
      color: #7f8c8d;
    }

    .barcode-preview svg {
      width: 100%;
      height: 60px;
    }

    .barcode-value {
      font-size: 11px;
      color: #95a5a6;
      margin-top: 5px;
      font-family: 'Courier New', monospace;
    }

    .status-bar {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
    }

    .status-connected {
      background: rgba(46, 204, 113, 0.1);
      color: #27ae60;
      border: 1px solid #27ae60;
    }

    .status-disconnected {
      background: rgba(231, 76, 60, 0.1);
      color: #c0392b;
      border: 1px solid #c0392b;
    }

    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 25px;
      border-radius: 8px;
      background: #2c3e50;
      color: white;
      font-weight: 500;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: none;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        transform: translate(-50%, -20px);
        opacity: 0;
      }
      to {
        transform: translate(-50%, 0);
        opacity: 1;
      }
    }

    .footer {
      text-align: center;
      margin-top: 20px;
      font-size: 12px;
      color: #95a5a6;
    }

    .icon {
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>POS Barcode Printer</h1>
      <p>Cetak barcode untuk kode & berat produk</p>
    </div>

    <div class="input-section">
      <div class="input-group">
        <label for="kode-input">Kode Produk</label>
        <input type="text" id="kode-input" placeholder="Contoh: 101011" maxlength="10">
      </div>
      <div class="input-group">
        <label for="berat-input">Berat Produk (gram)</label>
        <input type="text" id="berat-input" placeholder="Contoh: 0.332" maxlength="8">
      </div>
    </div>

    <div class="control-buttons">
      <button class="btn btn-primary" onclick="generateBarcodes()">
        <span class="icon">üîÑ</span> Generate
      </button>
      <button class="btn btn-warning" onclick="clearAll()">
        <span class="icon">üóëÔ∏è</span> Clear
      </button>
      <button class="btn btn-success" onclick="connectPrinter()">
        <span class="icon">üîó</span> Connect Printer
      </button>
      <button class="btn btn-danger" onclick="testPrint()">
        <span class="icon">üñ®Ô∏è</span> Test Print
      </button>
    </div>

    <button class="print-btn" onclick="printSticker()">
      <span class="icon">üñ®Ô∏è</span> CETAK STIKER BARCODE
    </button>

    <div class="preview-section">
      <div class="preview-title">Preview Barcode</div>
      <div class="barcode-preview">
        <div class="barcode-label">KODE PRODUK</div>
        <svg id="barcode-kode"></svg>
        <div class="barcode-value">Kode: <span id="kode-text">-</span></div>
      </div>
      <div class="barcode-preview">
        <div class="barcode-label">BERAT PRODUK</div>
        <svg id="barcode-berat"></svg>
        <div class="barcode-value">Berat: <span id="berat-text">-</span> gram</div>
      </div>
    </div>

    <div id="status" class="status-bar status-disconnected">
      Printer: Tidak Terhubung
    </div>

    <div class="footer">
      Aplikasi pencetak barcode untuk POS - Simple & Effective
    </div>
  </div>

  <div id="notification" class="notification"></div>

  <script>
    let port = null;
    let writer = null;
    let isConnected = false;

    // Fungsi untuk menampilkan notifikasi
    function showNotification(message, duration = 3000) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.display = 'block';
      setTimeout(() => {
        notification.style.display = 'none';
      }, duration);
    }

    // Fungsi untuk memperbarui status koneksi
    function updateConnectionStatus(connected) {
      const status = document.getElementById('status');
      isConnected = connected;
      
      if (connected) {
        status.className = 'status-bar status-connected';
        status.innerHTML = 'Printer: Terhubung ‚úì';
        showNotification('Printer berhasil terhubung!', 2000);
      } else {
        status.className = 'status-bar status-disconnected';
        status.innerHTML = 'Printer: Tidak Terhubung';
      }
    }

    // Fungsi untuk menghubungkan printer
    async function connectPrinter() {
      try {
        if (!("serial" in navigator)) {
          showNotification("Browser tidak mendukung Web Serial API. Gunakan Chrome/Edge versi terbaru.");
          return;
        }

        showNotification("Memilih printer...");
        port = await navigator.serial.requestPort();
        
        showNotification("Membuka koneksi...");
        await port.open({ baudRate: 9600 });
        writer = port.writable.getWriter();
        
        updateConnectionStatus(true);
      } catch (error) {
        console.error("Koneksi error:", error);
        if (error.name === 'NotFoundError') {
          showNotification("Tidak ada printer yang dipilih");
        } else if (error.name === 'InvalidStateError') {
          showNotification("Printer sudah terhubung");
          updateConnectionStatus(true);
        } else {
          showNotification("Gagal terhubung: " + error.message);
        }
        updateConnectionStatus(false);
      }
    }

    // Fungsi untuk generate barcode
    function generateBarcodes() {
      const kodeValue = document.getElementById('kode-input').value.trim();
      const beratValue = document.getElementById('berat-input').value.trim();

      if (!kodeValue) {
        showNotification('Masukkan kode produk terlebih dahulu');
        return;
      }

      if (!beratValue) {
        showNotification('Masukkan berat produk terlebih dahulu');
        return;
      }

      // Validasi kode hanya angka
      if (!/^\d+$/.test(kodeValue)) {
        showNotification('Kode produk hanya boleh angka');
        return;
      }

      // Validasi berat format angka dengan titik
      if (!/^\d*\.?\d*$/.test(beratValue)) {
        showNotification('Berat produk harus angka (contoh: 0.332)');
        return;
      }

      // Generate barcode untuk kode
      try {
        JsBarcode("#barcode-kode", kodeValue, {
          format: "CODE128",
          displayValue: false,
          height: 50,
          margin: 0,
          fontSize: 0
        });
        document.getElementById('kode-text').textContent = kodeValue;
      } catch (e) {
        showNotification('Kode tidak valid untuk barcode');
        return;
      }

      // Generate barcode untuk berat
      try {
        JsBarcode("#barcode-berat", beratValue, {
          format: "CODE128",
          displayValue: false,
          height: 50,
          margin: 0,
          fontSize: 0
        });
        document.getElementById('berat-text').textContent = beratValue;
      } catch (e) {
        showNotification('Berat tidak valid untuk barcode');
        return;
      }

      showNotification('Barcode berhasil digenerate! Siap dicetak.');
    }

    // Fungsi untuk clear semua input
    function clearAll() {
      document.getElementById('kode-input').value = '';
      document.getElementById('berat-input').value = '';
      document.getElementById('barcode-kode').innerHTML = '';
      document.getElementById('barcode-berat').innerHTML = '';
      document.getElementById('kode-text').textContent = '-';
      document.getElementById('berat-text').textContent = '-';
      showNotification('Semua data telah dihapus');
    }

    // Fungsi untuk mencetak stiker
    async function printSticker() {
      const kodeValue = document.getElementById('kode-input').value.trim();
      const beratValue = document.getElementById('berat-input').value.trim();

      if (!kodeValue || !beratValue) {
        showNotification('Generate barcode terlebih dahulu');
        return;
      }

      if (!isConnected || !writer) {
        showNotification('Hubungkan printer terlebih dahulu');
        return;
      }

      try {
        showNotification('Mencetak stiker barcode...');

        const encoder = new TextEncoder();
        let commands = [];
        
        // Reset printer
        commands.push(0x1B, 0x40);
        
        // Set line spacing minimal
        commands.push(0x1B, 0x33, 0x08);
        
        // Set alignment center
        commands.push(0x1B, 0x61, 0x01);
        
        // Cetak header kecil
        commands.push(0x1B, 0x21, 0x00);
        const header = encoder.encode("PRODUK\n\n");
        commands = commands.concat(Array.from(header));
        
        // Barcode untuk kode produk
        const GS = 0x1D;
        let barcodeKode = [];
        barcodeKode.push(GS, 0x68, 0x40); // Height
        barcodeKode.push(GS, 0x77, 0x01); // Width tipis
        barcodeKode.push(GS, 0x6B, 0x49); // CODE128
        barcodeKode.push(kodeValue.length);
        
        const kodeBytes = encoder.encode(kodeValue);
        barcodeKode = barcodeKode.concat(Array.from(kodeBytes));
        commands = commands.concat(barcodeKode);
        
        // Teks kode
        commands.push(0x0A);
        commands.push(0x1B, 0x21, 0x01);
        const kodeText = encoder.encode("Kode: " + kodeValue + "\n\n");
        commands = commands.concat(Array.from(kodeText));
        
        // Barcode untuk berat
        commands.push(0x1B, 0x21, 0x00);
        
        let barcodeBerat = [];
        barcodeBerat.push(GS, 0x68, 0x40);
        barcodeBerat.push(GS, 0x77, 0x01);
        barcodeBerat.push(GS, 0x6B, 0x49);
        barcodeBerat.push(beratValue.length);
        
        const beratBytes = encoder.encode(beratValue);
        barcodeBerat = barcodeBerat.concat(Array.from(beratBytes));
        commands = commands.concat(barcodeBerat);
        
        // Teks berat
        commands.push(0x0A);
        commands.push(0x1B, 0x21, 0x01);
        const beratText = encoder.encode("Berat: " + beratValue + "g\n\n");
        commands = commands.concat(Array.from(beratText));
        
        // Potong kertas
        commands.push(0x1D, 0x56, 0x41, 0x00);
        
        // Kirim ke printer
        await writer.write(new Uint8Array(commands));
        
        showNotification('Stiker berhasil dicetak!', 2000);
      } catch (error) {
        console.error("Print error:", error);
        showNotification("Gagal mencetak: " + error.message);
      }
    }

    // Fungsi untuk test print
    async function testPrint() {
      if (!isConnected || !writer) {
        showNotification('Hubungkan printer terlebih dahulu');
        return;
      }

      try {
        showNotification('Mencetak test page...');

        const encoder = new TextEncoder();
        let commands = [];
        
        commands.push(0x1B, 0x40);
        commands.push(0x1B, 0x61, 0x01);
        
        const testText = encoder.encode("TEST PRINTER\n================\nJika ini tercetak,\nprinter berfungsi.\n\n\n\n");
        commands = commands.concat(Array.from(testText));
        
        commands.push(0x1D, 0x56, 0x41, 0x00);
        
        await writer.write(new Uint8Array(commands));
        
        showNotification('Test print berhasil!', 2000);
      } catch (error) {
        console.error("Test print error:", error);
        showNotification("Gagal test print: " + error.message);
      }
    }

    // Event listener untuk input
    document.getElementById('kode-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        generateBarcodes();
      }
    });

    document.getElementById('berat-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        generateBarcodes();
      }
    });

    // Inisialisasi
    document.addEventListener('DOMContentLoaded', function() {
      showNotification('Masukkan kode dan berat produk, lalu klik Generate', 5000);
    });
  </script>
</body>
</html>
