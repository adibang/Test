<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POS Barcode Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    /* Reset & Base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
      background: #DAE8F2;
      min-height: 100vh;
      color: #333;
    }
    
    /* Header */
    .app-header {
      background: #1D9BF0;
      color: white;
      padding: 16px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .app-title {
      font-size: 1.2rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .header-actions {
      display: flex;
      gap: 8px;
    }
    
    /* Main Content */
    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Category Tabs */
    .category-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      padding: 0 5px;
      overflow-x: auto;
      white-space: nowrap;
      position: relative;
    }
    
    .category-tab {
      padding: 8px 16px;
      background: white;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
      border: 1px solid #dee2e6;
      color: #495057;
      font-weight: 500;
      flex-shrink: 0;
      position: relative;
      touch-action: manipulation;
    }
    
    .category-tab:hover {
      border-color: #1D9BF0;
      color: #1D9BF0;
    }
    
    .category-tab.active {
      background: #1D9BF0;
      color: white;
      border-color: #1D9BF0;
    }
    
    /* Products Grid */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
    }
    
    /* Product Card */
    .product-card {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      border: 1px solid #e9ecef;
      position: relative;
      height: 260px;
      display: flex;
      flex-direction: column;
    }
    
    .product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      border-color: #1D9BF0;
    }
    
    .product-card.selected {
      border: 2px solid #1D9BF0;
    }
    
    /* Product Image */
    .product-image {
      width: 100%;
      height: 160px;
      object-fit: cover;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
      flex-shrink: 0;
    }
    
    /* Product Info */
    .product-info {
      padding: 12px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    
    .product-name {
      font-weight: 600;
      font-size: 0.85rem;
      color: #2c3e50;
      margin-bottom: 5px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      height: 34px;
      line-height: 1.4;
    }
    
    .product-code {
      font-size: 0.8rem;
      color: #6c757d;
      font-family: monospace;
      background: #f8f9fa;
      padding: 3px 8px;
      border-radius: 4px;
      display: inline-block;
    }
    
    /* Product Actions */
    .product-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 5px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .product-card:hover .product-actions {
      opacity: 1;
    }
    
    .action-btn {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }
    
    .edit-btn {
      background: #1D9BF0;
      color: white;
    }
    
    .edit-btn:hover {
      background: #0d8de0;
    }
    
    .delete-btn {
      background: #ff6b6b;
      color: white;
    }
    
    .delete-btn:hover {
      background: #ff5252;
    }
    
    /* Add Product Card */
    .add-product-card {
      background: white;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      border: 2px dashed #A3D5D9;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 260px;
    }
    
    .add-product-card:hover {
      border-color: #1D9BF0;
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    
    .add-product-content {
      text-align: center;
      padding: 20px;
    }
    
    .add-icon {
      font-size: 32px;
      color: #1D9BF0;
      margin-bottom: 10px;
    }
    
    .add-text {
      color: #1D9BF0;
      font-weight: 600;
      font-size: 0.85rem;
    }
    
    /* Modal Overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 15px;
    }
    
    /* Modal Content */
    .modal-content {
      background: #1D9BF0;
      border-radius: 25px;
      width: 100%;
      max-width: 450px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.2s ease;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Modal Header */
    .modal-header {
      padding: 12px 20px;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
    }
    
    .modal-title {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .close-modal {
      display: none;
    }
    
    .modal-body {
      padding: 0 20px 20px;
      max-height: calc(90vh - 60px);
      overflow-y: auto;
    }
    
    /* Display Section */
    .display-section {
      background: #A3D5D9;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 20px;
      text-align: right;
      font-family: monospace;
      font-size: 1.1em;
      color: #333;
    }
    
    .display-row {
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
    }
    
    .display-row:last-child {
      margin-bottom: 0;
    }
    
    /* Product Info Compact */
    .product-info-section {
      background: rgba(255, 255, 255, 0.2);
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 15px;
      display: flex;
      gap: 12px;
      align-items: center;
      color: white;
    }
    
    .product-thumbnail {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      object-fit: cover;
      background: white;
    }
    
    .product-details h4 {
      color: white;
      margin-bottom: 4px;
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .product-details .code {
      color: rgba(255, 255, 255, 0.8);
      font-family: monospace;
      font-size: 0.8rem;
    }
    
    /* Printer Status */
    .printer-status {
      padding: 8px;
      border-radius: 15px;
      text-align: center;
      color: white;
      font-size: 13px;
      margin-bottom: 15px;
      background: rgba(0, 0, 0, 0.2);
    }
    
    .status-connected { 
      background-color: #28a745; 
    }
    
    .status-disconnected { 
      background-color: #dc3545; 
    }
    
    /* Buttons Grid */
    .function-row, .buttons {
      display: grid;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .function-row {
      grid-template-columns: repeat(3, 1fr);
    }
    
    .buttons {
      grid-template-columns: repeat(3, 1fr);
    }
    
    button {
      padding: 14px 8px;
      border: none;
      background: #ffffff;
      color: #333;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      min-height: 48px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      transition: all 0.2s;
      font-weight: 600;
    }
    
    button:active {
      transform: scale(0.98);
      box-shadow: 0 0 0 3px rgba(29, 155, 240, 0.3);
    }
    
    /* Function Buttons */
    .function-btn {
      background: #ffffff;
      color: #1D9BF0;
      font-weight: 600;
    }
    
    .function-btn:active {
      background: #1D9BF0;
      color: white;
    }
    
    .backspace-btn {
      background: #ff6b6b;
      color: white;
    }
    
    .backspace-btn:active {
      background: #ff5252;
    }
    
    .print-btn {
      grid-column: span 3;
      background: #ffffff !important;
      color: #1D9BF0;
      font-weight: 600;
    }
    
    .print-btn:active {
      background: #1D9BF0 !important;
      color: white;
    }
    
    .active-mode {
      background: #1D9BF0 !important;
      color: white;
    }
    
    /* Barcode Preview */
    .barcode-preview {
      background: #A3D5D9;
      padding: 15px;
      border-radius: 20px;
      margin-top: 15px;
      text-align: center;
      font-size: 12px;
      color: #333;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .barcode-container {
      width: 100%;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border-radius: 10px;
      margin: 10px 0;
      padding: 10px;
      overflow: hidden;
    }
    
    #barcode-svg {
      width: 100%;
      height: 80px;
    }
    
    .barcode-info {
      font-size: 0.9rem;
      color: #333;
      margin-top: 5px;
      font-family: monospace;
      word-break: break-all;
      background: white;
      padding: 8px;
      border-radius: 8px;
    }
    
    /* Settings Modal */
    .settings-modal .modal-content {
      background: white;
      max-width: 400px;
    }
    
    .settings-modal .modal-header {
      background: #1D9BF0;
    }
    
    .settings-content {
      padding: 20px;
    }
    
    .setting-group {
      margin-bottom: 15px;
    }
    
    .setting-label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    .setting-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 1rem;
      text-align: center;
    }
    
    .digit-summary {
      background: #DAE8F2;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      margin: 20px 0;
      border: 2px solid #A3D5D9;
    }
    
    /* Category Management */
    .category-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 8px;
      border: 1px solid #e9ecef;
    }
    
    .category-item:last-child {
      margin-bottom: 0;
    }
    
    .category-actions {
      display: flex;
      gap: 5px;
    }
    
    /* Category Context Menu */
    .category-context-menu {
      position: fixed;
      background: white;
      border-radius: 15px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      z-index: 1001;
      min-width: 180px;
      overflow: hidden;
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .context-menu-item {
      padding: 15px 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.2s;
      border-bottom: 1px solid #f1f3f5;
    }
    
    .context-menu-item:last-child {
      border-bottom: none;
    }
    
    .context-menu-item:hover {
      background: #f8f9fa;
    }
    
    .context-menu-item.edit {
      color: #1D9BF0;
    }
    
    .context-menu-item.delete {
      color: #ff6b6b;
    }
    
    /* Notification */
    #notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 5px;
      display: none;
      color: white;
      background-color: #1D9BF0;
      max-width: 90%;
      text-align: center;
      z-index: 1001;
      font-size: 14px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    /* CSS untuk Dropdown */
    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%231D9BF0' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 40px !important;
      cursor: pointer;
    }
    
    select:focus {
      outline: none;
      border-color: #1D9BF0;
      box-shadow: 0 0 0 3px rgba(29, 155, 240, 0.1);
    }
    
    /* Tombol Settings di Header */
    .header-actions button {
      background: white;
      color: #1D9BF0;
      padding: 8px 12px;
      border-radius: 25px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .header-actions button:hover {
      background: #0d8de0;
      color: white;
    }
    
    /* Responsive Grid untuk Tablet */
    @media (max-width: 768px) {
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 16px;
      }
      
      .product-card {
        height: 240px;
      }
      
      .product-image {
        height: 140px;
      }
      
      .modal-content {
        max-width: 95%;
      }
      
      .modal-header {
        padding: 10px 15px;
      }
      
      .modal-body {
        padding: 0 15px 15px;
      }
      
      button {
        padding: 12px 6px;
        font-size: 14px;
        min-height: 44px;
      }
    }
    
    /* Responsive Grid untuk Mobile */
    @media (max-width: 480px) {
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
      }
      
      .product-card {
        height: 220px;
      }
      
      .product-image {
        height: 130px;
      }
      
      .modal-header {
        padding: 8px 12px;
      }
      
      .modal-title {
        font-size: 0.95rem;
      }
      
      .modal-body {
        padding: 0 12px 12px;
      }
      
      button {
        padding: 10px 4px;
        font-size: 13px;
        min-height: 40px;
      }
    }
    
    /* Warna untuk input focus */
    input:focus, textarea:focus {
      outline: none;
      border-color: #1D9BF0;
      box-shadow: 0 0 0 3px rgba(29, 155, 240, 0.1);
    }
    
    /* Warna untuk tombol dalam form */
    .form-button-primary {
      background: #1D9BF0;
      color: white;
    }
    
    .form-button-primary:hover {
      background: #0d8de0;
    }
    
    .form-button-secondary {
      background: #A3D5D9;
      color: #333;
    }
    
    .form-button-secondary:hover {
      background: #93c5c9;
    }
    
    /* Long Press Indicator */
    .long-press-indicator {
      position: fixed;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 9999;
      pointer-events: none;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="header-content">
      <div class="app-title">
        <span>üì¶</span>
        POS Barcode Generator
      </div>
      <div class="header-actions">
        <button onclick="showSettingsModal()">
          ‚öôÔ∏è Settings
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Category Tabs -->
    <div class="category-tabs" id="category-tabs">
      <!-- Categories will be loaded here -->
    </div>
    
    <!-- Products Grid -->
    <div class="products-grid" id="products-grid">
      <!-- Products will be loaded here -->
    </div>
  </main>

  <!-- Weight Input Modal -->
  <div class="modal-overlay" id="weight-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">‚öñÔ∏è Input Berat</h2>
      </div>
      <div class="modal-body">
        <!-- Product Info -->
        <div class="product-info-section" id="selected-product-info">
          <!-- Product info will be loaded here -->
        </div>
        
        <!-- Display -->
        <div class="display-section">
          <div class="display-row">
            <span>PRODUK:</span>
            <span id="display-product-code">-</span>
          </div>
          <div class="display-row">
            <span>BERAT:</span>
            <span id="display-weight">0</span> <span style="font-size:0.9em">gram</span>
          </div>
          <div class="display-row">
            <span>BARCODE:</span>
            <span id="display-barcode">-</span>
          </div>
        </div>
        
        <!-- Printer Status -->
        <div id="status" class="printer-status status-disconnected">Printer: Tidak Terkoneksi</div>
        
        <!-- Function Row -->
        <div class="function-row">
          <button id="clear-btn" class="function-btn" onclick="clearWeight()">CLEAR</button>
          <button id="generate-btn" class="function-btn" onclick="generateBarcode()">GENERATE</button>
          <button id="connect-btn" class="function-btn" onclick="connectToPrinter()">CONNECT</button>
        </div>
        
        <!-- Number Buttons -->
        <div class="buttons">
          <button onclick="appendNumber('7')">7</button>
          <button onclick="appendNumber('8')">8</button>
          <button onclick="appendNumber('9')">9</button>
          
          <button onclick="appendNumber('4')">4</button>
          <button onclick="appendNumber('5')">5</button>
          <button onclick="appendNumber('6')">6</button>
          
          <button onclick="appendNumber('1')">1</button>
          <button onclick="appendNumber('2')">2</button>
          <button onclick="appendNumber('3')">3</button>
          
          <button onclick="appendNumber('0')">0</button>
          <button onclick="appendNumber('00')">00</button>
          <button class="backspace-btn" onclick="backspaceWeight()">‚å´</button>
          
          <button class="print-btn function-btn" onclick="printBarcode()">PRINT</button>
        </div>
        
        <!-- Barcode Preview -->
        <div class="barcode-preview">
          <div style="font-weight:600;color:#333;margin-bottom:10px;">PREVIEW BARCODE</div>
          <div class="barcode-container">
            <svg id="barcode-svg"></svg>
          </div>
          <div class="barcode-info" id="current-barcode">Klik GENERATE untuk membuat barcode</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Product Modal -->
  <div class="modal-overlay" id="product-modal">
    <div class="modal-content" style="background:white;">
      <div class="modal-header" style="background:#1D9BF0;">
        <h2 class="modal-title" id="product-modal-title">‚ûï Tambah Produk</h2>
      </div>
      <div class="modal-body">
        <div id="product-form-content">
          <!-- Form will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settings-modal">
    <div class="modal-content" style="background:white;">
      <div class="modal-header" style="background:#1D9BF0;">
        <h2 class="modal-title">‚öôÔ∏è Pengaturan</h2>
      </div>
      <div class="modal-body">
        <div id="settings-content">
          <!-- Settings will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Category Context Menu -->
  <div id="category-context-menu" class="category-context-menu" style="display:none;"></div>

  <!-- Long Press Indicator -->
  <div id="long-press-indicator" class="long-press-indicator" style="display:none;">Tahan untuk edit/hapus</div>

  <!-- Notification -->
  <div id="notification"></div>

  <script>
    // Global Variables
    let products = [];
    let categories = [];
    let currentProduct = null;
    let weightValue = '';
    let digitConfig = { flex: 2, category: 2, product: 4, weight: 5 };
    let selectedCategory = 'all';
    let editingProductId = null;
    let port = null;
    let writer = null;
    let isPrinterConnected = false;
    let currentBarcodeData = '';
    
    // Variables for long press handling
    let longPressTimer = null;
    let longPressCategory = null;
    let isLongPress = false;

    // Initialize App
    function initApp() {
      loadSettings();
      loadProducts();
      loadCategories();
      renderCategories();
      renderProducts();
      checkPrinterConnection();
      
      // Initialize long press events
      initLongPressEvents();
    }

    // Initialize long press events
    function initLongPressEvents() {
      document.addEventListener('touchstart', handleTouchStart, { passive: true });
      document.addEventListener('touchend', handleTouchEnd);
      document.addEventListener('touchcancel', handleTouchEnd);
      document.addEventListener('mousedown', handleMouseDown);
      document.addEventListener('mouseup', handleMouseUp);
    }

    // Load Settings
    function loadSettings() {
      const savedConfig = localStorage.getItem('barcodeConfig');
      if (savedConfig) {
        digitConfig = JSON.parse(savedConfig);
      }
    }

    // Save Settings
    function saveSettings() {
      localStorage.setItem('barcodeConfig', JSON.stringify(digitConfig));
    }

    // Load Products
    function loadProducts() {
      const saved = localStorage.getItem('posProducts');
      if (saved) {
        products = JSON.parse(saved);
      } else {
        // Sample products
        products = [
          {
            id: 1,
            name: "Beras Premium 5kg",
            code: "0001",
            category: "Sembako",
            flex: "01",
            catcode: "01",
            image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23DAE8F2'/%3E%3Cpath d='M30,40 L70,40 L65,60 L35,60 Z' fill='%231D9BF0'/%3E%3Ccircle cx='50' cy='35' r='15' fill='%23A3D5D9'/%3E%3C/svg%3E"
          },
          {
            id: 2,
            name: "Gula Pasir 1kg",
            code: "0002",
            category: "Sembako",
            flex: "01",
            catcode: "01",
            image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23DAE8F2'/%3E%3Crect x='30' y='30' width='40' height='40' fill='%23fff' stroke='%231D9BF0' stroke-width='2'/%3E%3C/svg%3E"
          },
          {
            id: 3,
            name: "Minyak Goreng 2L",
            code: "0003",
            category: "Sembako",
            flex: "01",
            catcode: "02",
            image: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23DAE8F2'/%3E%3Crect x='35' y='25' width='30' height='50' fill='%23A3D5D9'/%3E%3Ccircle cx='50' cy='80' r='8' fill='%231D9BF0'/%3E%3C/svg%3E"
          }
        ];
        saveProducts();
      }
    }

    // Load Categories
    function loadCategories() {
      const saved = localStorage.getItem('posCategories');
      if (saved) {
        categories = JSON.parse(saved);
      } else {
        // Extract unique categories from products and add "all"
        const allCategories = ['all'];
        products.forEach(product => {
          if (product.category && !allCategories.includes(product.category)) {
            allCategories.push(product.category);
          }
        });
        categories = allCategories;
        saveCategories();
      }
    }

    // Save Categories
    function saveCategories() {
      localStorage.setItem('posCategories', JSON.stringify(categories));
    }

    // Save Products
    function saveProducts() {
      localStorage.setItem('posProducts', JSON.stringify(products));
      loadCategories();
      renderCategories();
      renderProducts();
    }

    // Render Categories with long press support
    function renderCategories() {
      const container = document.getElementById('category-tabs');
      container.innerHTML = '';
      
      categories.forEach(category => {
        const tab = document.createElement('div');
        tab.className = `category-tab ${selectedCategory === category ? 'active' : ''}`;
        tab.textContent = category === 'all' ? 'Semua Produk' : category;
        tab.dataset.category = category;
        
        // Regular click for category selection
        tab.onclick = () => {
          if (!isLongPress) {
            selectedCategory = category;
            renderCategories();
            renderProducts();
          }
          isLongPress = false;
        };
        
        container.appendChild(tab);
      });
    }

    // Handle touch start for long press
    function handleTouchStart(e) {
      const categoryTab = e.target.closest('.category-tab');
      if (categoryTab && categoryTab.dataset.category !== 'all') {
        longPressCategory = categoryTab.dataset.category;
        
        // Show indicator
        const indicator = document.getElementById('long-press-indicator');
        indicator.style.display = 'block';
        indicator.style.left = e.touches[0].clientX + 'px';
        indicator.style.top = e.touches[0].clientY + 'px';
        
        // Start long press timer
        longPressTimer = setTimeout(() => {
          isLongPress = true;
          showCategoryContextMenu(longPressCategory, e.touches[0].clientX, e.touches[0].clientY);
          indicator.style.display = 'none';
        }, 800); // 800ms for long press
        
        e.preventDefault();
      }
    }

    // Handle touch end
    function handleTouchEnd() {
      clearTimeout(longPressTimer);
      document.getElementById('long-press-indicator').style.display = 'none';
    }

    // Handle mouse down for long press
    function handleMouseDown(e) {
      if (e.button !== 0) return; // Only left click
      
      const categoryTab = e.target.closest('.category-tab');
      if (categoryTab && categoryTab.dataset.category !== 'all') {
        longPressCategory = categoryTab.dataset.category;
        
        // Show indicator
        const indicator = document.getElementById('long-press-indicator');
        indicator.style.display = 'block';
        indicator.style.left = e.clientX + 'px';
        indicator.style.top = e.clientY + 'px';
        
        // Start long press timer
        longPressTimer = setTimeout(() => {
          isLongPress = true;
          showCategoryContextMenu(longPressCategory, e.clientX, e.clientY);
          indicator.style.display = 'none';
        }, 800);
      }
    }

    // Handle mouse up
    function handleMouseUp() {
      clearTimeout(longPressTimer);
      document.getElementById('long-press-indicator').style.display = 'none';
    }

    // Show category context menu
    function showCategoryContextMenu(category, x, y) {
      const menu = document.getElementById('category-context-menu');
      menu.innerHTML = '';
      
      const editItem = document.createElement('div');
      editItem.className = 'context-menu-item edit';
      editItem.innerHTML = '‚úèÔ∏è Edit Kategori';
      editItem.onclick = () => {
        editCategory(category);
        menu.style.display = 'none';
      };
      
      const deleteItem = document.createElement('div');
      deleteItem.className = 'context-menu-item delete';
      deleteItem.innerHTML = 'üóëÔ∏è Hapus Kategori';
      deleteItem.onclick = () => {
        deleteCategory(category);
        menu.style.display = 'none';
      };
      
      menu.appendChild(editItem);
      menu.appendChild(deleteItem);
      
      // Position menu
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      menu.style.display = 'block';
      
      // Close menu when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
          if (!menu.contains(e.target)) {
            menu.style.display = 'none';
            document.removeEventListener('click', closeMenu);
          }
        });
      }, 100);
    }

    // Edit category
    function editCategory(oldCategory) {
      if (oldCategory === 'all') return;
      
      const newCategory = prompt('Edit nama kategori:', oldCategory);
      if (newCategory && newCategory.trim() && newCategory !== oldCategory) {
        // Update category in categories array
        const index = categories.indexOf(oldCategory);
        if (index !== -1) {
          categories[index] = newCategory;
        }
        
        // Update category in all products
        products.forEach(product => {
          if (product.category === oldCategory) {
            product.category = newCategory;
          }
        });
        
        // Update selected category if it's the edited one
        if (selectedCategory === oldCategory) {
          selectedCategory = newCategory;
        }
        
        saveCategories();
        saveProducts();
        renderCategories();
        renderProducts();
        showNotification('Kategori berhasil diubah!');
      }
    }

    // Delete category
    function deleteCategory(category) {
      if (category === 'all') return;
      
      if (!confirm(`Hapus kategori "${category}"?\n\nProduk dalam kategori ini akan dipindahkan ke kategori "Semua Produk".`)) {
        return;
      }
      
      // Move products to default category or uncategorized
      products.forEach(product => {
        if (product.category === category) {
          product.category = "Lainnya";
        }
      });
      
      // Remove category from categories array
      categories = categories.filter(cat => cat !== category);
      
      // Add "Lainnya" category if it doesn't exist
      if (!categories.includes("Lainnya")) {
        categories.push("Lainnya");
      }
      
      // Update selected category if it's the deleted one
      if (selectedCategory === category) {
        selectedCategory = 'all';
      }
      
      saveCategories();
      saveProducts();
      renderCategories();
      renderProducts();
      showNotification('Kategori berhasil dihapus!');
    }

    // Render Products
    function renderProducts() {
      const container = document.getElementById('products-grid');
      container.innerHTML = '';
      
      const filteredProducts = selectedCategory === 'all' 
        ? products 
        : products.filter(p => p.category === selectedCategory);
      
      filteredProducts.forEach(product => {
        const card = document.createElement('div');
        card.className = `product-card ${currentProduct?.id === product.id ? 'selected' : ''}`;
        card.innerHTML = `
          <img src="${product.image}" alt="${product.name}" class="product-image">
          <div class="product-actions">
            <button class="action-btn edit-btn" onclick="editProduct(${product.id}, event)">‚úèÔ∏è</button>
            <button class="action-btn delete-btn" onclick="deleteProduct(${product.id}, event)">üóëÔ∏è</button>
          </div>
          <div class="product-info">
            <div class="product-name">${product.name}</div>
            <div class="product-code">${product.code}</div>
          </div>
        `;
        card.onclick = () => {
          currentProduct = product;
          showWeightModal();
        };
        container.appendChild(card);
      });
      
      const addCard = document.createElement('div');
      addCard.className = 'add-product-card';
      addCard.innerHTML = `
        <div class="add-product-content">
          <div class="add-icon">Ôºã</div>
          <div class="add-text">Tambah Produk</div>
        </div>
      `;
      addCard.onclick = () => showProductModal();
      container.appendChild(addCard);
    }

    // Edit Product
    function editProduct(productId, event) {
      event.stopPropagation();
      const product = products.find(p => p.id === productId);
      if (!product) return;
      
      editingProductId = productId;
      showProductModal(product);
    }

    // Delete Product
    function deleteProduct(productId, event) {
      event.stopPropagation();
      if (!confirm('Hapus produk ini?')) return;
      
      products = products.filter(p => p.id !== productId);
      saveProducts();
      showNotification('Produk dihapus!');
      
      if (currentProduct && currentProduct.id === productId) {
        currentProduct = null;
      }
    }

    // Show Product Modal (Add/Edit) - FIXED CATEGORY HANDLING
    function showProductModal(product = null) {
      const isEdit = !!product;
      const modalTitle = document.getElementById('product-modal-title');
      modalTitle.textContent = isEdit ? '‚úèÔ∏è Edit Produk' : '‚ûï Tambah Produk';
      
      // Get existing categories (excluding "all")
      const existingCategories = categories.filter(cat => cat !== 'all');
      
      let categoryOptions = existingCategories.map(cat => {
        const selected = product && product.category === cat ? 'selected' : '';
        return `<option value="${cat}" ${selected}>${cat}</option>`;
      }).join('');
      
      const formContent = document.getElementById('product-form-content');
      formContent.innerHTML = `
        <div style="margin-bottom:15px;">
          <div style="color:#333;margin-bottom:5px;font-weight:500;">Gambar Produk</div>
          <div style="border:2px dashed #A3D5D9;border-radius:10px;padding:20px;text-align:center;cursor:pointer;background:#DAE8F2;"
               onclick="document.getElementById('product-image-input').click()" id="image-upload-area">
            ${product && product.image ? 
              `<img src="${product.image}" style="max-width:100%;max-height:140px;border-radius:5px;object-fit:cover;" id="image-preview">` :
              `<div style="color:#666;">
                <div style="font-size:36px;margin-bottom:5px;">üì∑</div>
                <div>Klik untuk upload gambar</div>
                <div style="font-size:12px;margin-top:5px;color:#999;">Rekomendasi: 300x300px</div>
              </div>`
            }
          </div>
          <input type="file" id="product-image-input" accept="image/*" style="display:none">
        </div>
        
        <div style="margin-bottom:15px;">
          <div style="color:#333;margin-bottom:5px;font-weight:500;">Nama Produk</div>
          <input type="text" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;font-size:1rem;" 
                 id="product-name-input" value="${product ? product.name : ''}" placeholder="Nama produk" required>
        </div>
        
        <div style="margin-bottom:15px;">
          <div style="color:#333;margin-bottom:5px;font-weight:500;">Kode Produk (4 digit)</div>
          <input type="text" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;font-size:1rem;" 
                 id="product-code-input" value="${product ? product.code : ''}" placeholder="0001" maxlength="4" required>
        </div>
        
        <div style="margin-bottom:15px;">
          <div style="color:#333;margin-bottom:5px;font-weight:500;">Kategori</div>
          <div style="display:flex;gap:10px;">
            <select style="flex:1;padding:12px;border:1px solid #ddd;border-radius:10px;font-size:1rem;background:white;" 
                    id="product-category-select" onchange="handleCategorySelect()">
              <option value="">-- Pilih Kategori --</option>
              ${categoryOptions}
              <option value="_new">‚ûï Tambah Kategori Baru</option>
            </select>
          </div>
          <div id="new-category-input" style="margin-top:10px;display:none;">
            <input type="text" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;font-size:1rem;" 
                   id="product-category-new" placeholder="Nama kategori baru">
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;">
          <div>
            <div style="color:#333;margin-bottom:5px;font-weight:500;">Flex Code (2 digit)</div>
            <input type="text" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;font-size:1rem;" 
                   id="product-flex-input" value="${product ? product.flex : '01'}" placeholder="01" maxlength="2">
          </div>
          <div>
            <div style="color:#333;margin-bottom:5px;font-weight:500;">Kategori Code (2 digit)</div>
            <input type="text" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;font-size:1rem;" 
                   id="product-catcode-input" value="${product ? product.catcode : '01'}" placeholder="01" maxlength="2">
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <button style="padding:14px;border:none;border-radius:25px;background:#A3D5D9;color:#333;font-weight:600;cursor:pointer;" onclick="closeProductModal()">BATAL</button>
          <button style="padding:14px;border:none;border-radius:25px;background:#1D9BF0;color:white;font-weight:600;cursor:pointer;" onclick="saveProduct()">${isEdit ? 'UPDATE' : 'SIMPAN'}</button>
        </div>
      `;
      
      const imageInput = document.getElementById('product-image-input');
      const imageUploadArea = document.getElementById('image-upload-area');
      
      imageInput.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!file.type.match('image.*')) {
          showNotification('File harus gambar!', 'error');
          return;
        }
        
        if (file.size > 2 * 1024 * 1024) {
          showNotification('Maksimal 2MB!', 'error');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(event) {
          imageUploadArea.innerHTML = `<img src="${event.target.result}" style="max-width:100%;max-height:140px;border-radius:5px;object-fit:cover;" id="image-preview">`;
        };
        reader.readAsDataURL(file);
      };
      
      if (product && product.category) {
        setTimeout(() => {
          const select = document.getElementById('product-category-select');
          if (select) select.value = product.category;
        }, 10);
      }
      
      document.getElementById('product-modal').style.display = 'flex';
    }

    // Handle category selection
    function handleCategorySelect() {
      const select = document.getElementById('product-category-select');
      const newCategoryDiv = document.getElementById('new-category-input');
      
      if (select.value === '_new') {
        newCategoryDiv.style.display = 'block';
        if (document.getElementById('product-category-new')) {
          document.getElementById('product-category-new').focus();
        }
      } else {
        newCategoryDiv.style.display = 'none';
      }
    }

    // Save Product - FIXED CATEGORY SAVING
    function saveProduct() {
      const name = document.getElementById('product-name-input').value.trim();
      const code = document.getElementById('product-code-input').value.trim();
      
      const categorySelect = document.getElementById('product-category-select');
      let category = categorySelect.value;
      
      if (category === '_new') {
        category = document.getElementById('product-category-new').value.trim();
        // Add new category to categories array if it doesn't exist
        if (category && !categories.includes(category) && category !== 'all') {
          categories.push(category);
          saveCategories();
        }
      }
      
      const flex = document.getElementById('product-flex-input').value.trim();
      const catcode = document.getElementById('product-catcode-input').value.trim();
      const imagePreview = document.getElementById('image-preview');
      
      if (!name || !code || !category) {
        showNotification('Isi nama, kode, dan kategori!', 'error');
        return;
      }
      
      if (code.length !== 4) {
        showNotification('Kode harus 4 digit!', 'error');
        return;
      }
      
      let imageData = '';
      if (imagePreview && imagePreview.src) {
        imageData = imagePreview.src;
      } else if (editingProductId) {
        const existingProduct = products.find(p => p.id === editingProductId);
        imageData = existingProduct ? existingProduct.image : '';
      } else {
        imageData = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3Crect width='300' height='300' fill='%23DAE8F2'/%3E%3Crect x='50' y='80' width='200' height='140' fill='%231D9BF0' rx='10'/%3E%3Ccircle cx='150' cy='150' r='50' fill='%23A3D5D9'/%3E%3Cpath d='M130 140 L150 160 L180 120' stroke='white' stroke-width='10' fill='none'/%3E%3C/svg%3E";
      }
      
      const productData = {
        id: editingProductId || Date.now(),
        name,
        code: code.padStart(4, '0'),
        category,
        flex: flex.padStart(2, '0'),
        catcode: catcode.padStart(2, '0'),
        image: imageData
      };
      
      if (editingProductId) {
        const index = products.findIndex(p => p.id === editingProductId);
        if (index !== -1) {
          products[index] = productData;
        }
      } else {
        products.push(productData);
      }
      
      saveProducts();
      showNotification(editingProductId ? 'Produk diperbarui!' : 'Produk ditambahkan!');
      closeProductModal();
    }

    // Close Product Modal
    function closeProductModal() {
      document.getElementById('product-modal').style.display = 'none';
      editingProductId = null;
    }

    // Show Weight Modal
    function showWeightModal() {
      if (!currentProduct) return;
      
      const productInfo = document.getElementById('selected-product-info');
      productInfo.innerHTML = `
        <img src="${currentProduct.image}" alt="${currentProduct.name}" class="product-thumbnail">
        <div class="product-details">
          <h4>${currentProduct.name}</h4>
          <div class="code">${currentProduct.code} | ${currentProduct.category}</div>
        </div>
      `;
      
      document.getElementById('display-product-code').textContent = currentProduct.code;
      
      weightValue = '';
      document.getElementById('display-weight').textContent = '0';
      document.getElementById('display-barcode').textContent = '-';
      
      const barcodeSvg = document.getElementById('barcode-svg');
      barcodeSvg.innerHTML = '';
      document.getElementById('current-barcode').textContent = 'Klik GENERATE untuk membuat barcode';
      currentBarcodeData = '';
      
      updateConnectionStatus();
      
      document.getElementById('weight-modal').style.display = 'flex';
    }

    // Close Weight Modal
    function closeWeightModal() {
      document.getElementById('weight-modal').style.display = 'none';
      currentProduct = null;
      weightValue = '';
      
      document.querySelectorAll('.product-card.selected').forEach(c => {
        c.classList.remove('selected');
      });
    }

    // Number Pad Functions
    function appendNumber(num) {
      if (num === '00') {
        if (weightValue.length <= digitConfig.weight - 2) {
          weightValue += '00';
        }
      } else if (weightValue.length < digitConfig.weight) {
        weightValue += num;
      }
      
      const displayWeight = weightValue || '0';
      document.getElementById('display-weight').textContent = displayWeight;
    }

    function clearWeight() {
      weightValue = '';
      document.getElementById('display-weight').textContent = '0';
    }

    function backspaceWeight() {
      if (weightValue.length > 0) {
        weightValue = weightValue.slice(0, -1);
      }
      const displayWeight = weightValue || '0';
      document.getElementById('display-weight').textContent = displayWeight;
    }

    // Printer Functions
    async function connectToPrinter() {
      try {
        if (!("serial" in navigator)) {
          showNotification("Browser tidak mendukung Web Serial API. Gunakan Chrome/Edge.");
          return false;
        }

        showNotification("Memilih printer...");
        
        port = await navigator.serial.requestPort();
        showNotification("Membuka koneksi...");
        
        await port.open({ baudRate: 9600 });
        
        writer = port.writable.getWriter();
        
        isPrinterConnected = true;
        updateConnectionStatus(true);
        showNotification('Printer Connected!');
        
        return true;
        
      } catch (error) {
        console.error("Connection error:", error);
        if (error.name === 'NotFoundError') {
          showNotification("Tidak ada printer yang dipilih");
        } else {
          showNotification("Gagal terhubung ke printer: " + error.message);
        }
        updateConnectionStatus(false);
        return false;
      }
    }

    function updateConnectionStatus(connected) {
      const statusElement = document.getElementById('status');
      if (connected === true) {
        statusElement.textContent = 'Printer: Terkoneksi';
        statusElement.className = 'printer-status status-connected';
      } else {
        statusElement.textContent = 'Printer: Tidak Terkoneksi';
        statusElement.className = 'printer-status status-disconnected';
      }
    }

    function checkPrinterConnection() {
      updateConnectionStatus(false);
    }

    // Generate Barcode
    function generateBarcode() {
      if (!currentProduct) {
        showNotification('Pilih produk terlebih dahulu!');
        return;
      }
      
      if (!weightValue || weightValue === '0') {
        showNotification('Masukkan berat terlebih dahulu!');
        return;
      }
      
      currentBarcodeData = 
        currentProduct.flex.padStart(digitConfig.flex, '0') +
        currentProduct.catcode.padStart(digitConfig.category, '0') +
        currentProduct.code.padStart(digitConfig.product, '0') +
        weightValue.padStart(digitConfig.weight, '0');
      
      const totalDigits = digitConfig.flex + digitConfig.category + digitConfig.product + digitConfig.weight;
      
      if (currentBarcodeData.length !== totalDigits) {
        showNotification(`Pastikan semua field terisi. Total harus ${totalDigits} digit`);
        return;
      }
      
      const barcodeSvg = document.getElementById('barcode-svg');
      barcodeSvg.innerHTML = '';
      
      try {
        JsBarcode("#barcode-svg", currentBarcodeData, {
          format: "CODE128",
          displayValue: true,
          fontSize: 16,
          height: 60,
          margin: 10,
          background: "white",
          lineColor: "#000000",
          width: 2
        });
        
        document.getElementById('display-barcode').textContent = currentBarcodeData;
        document.getElementById('current-barcode').textContent = currentBarcodeData;
        
        showNotification('Barcode berhasil digenerate!');
      } catch (error) {
        console.error("Barcode generation error:", error);
        showNotification('Gagal membuat barcode: ' + error.message, 'error');
      }
    }

    // Print Barcode
    async function printBarcode() {
      try {
        if (!currentProduct || !weightValue) {
          showNotification('Harap isi berat terlebih dahulu dan generate barcode');
          return;
        }
        
        if (!currentBarcodeData) {
          showNotification('Generate barcode terlebih dahulu!');
          return;
        }
        
        if (!isPrinterConnected || !writer) {
          showNotification('Printer belum terhubung. Klik CONNECT dulu.');
          return;
        }

        showNotification("Mengirim data ke printer...");
        
        const esc = '\x1B';
        const gs = '\x1D';
        const lf = '\x0A';
        
        let data = esc + '@';
        
        data += esc + 'a' + '\x01';
        
        data += `[${currentProduct.flex.padStart(digitConfig.flex, '0')}][${currentProduct.catcode.padStart(digitConfig.category, '0')}]` +
                `[${currentProduct.code.padStart(digitConfig.product, '0')}][${weightValue.padStart(digitConfig.weight, '0')}]${lf}`;
        
        data += lf;
        
        data += esc + 'a' + '\x01';
        
        data += gs + 'h' + '\x50';
        data += gs + 'w' + '\x02';
        data += gs + 'k' + '\x49';
        data += String.fromCharCode(currentBarcodeData.length);
        data += currentBarcodeData;
        
        data += lf;
        
        data += lf + lf;
        
        data += gs + 'V' + '\x41' + '\x00';
        
        const encoder = new TextEncoder();
        const encodedData = encoder.encode(data);
        
        await writer.write(encodedData);
        
        showNotification('Barcode berhasil dicetak!');
      } catch (error) {
        console.error("Print error:", error);
        showNotification("Gagal mengirim ke printer: " + error.message);
        
        if (error.message.includes("closed") || error.message.includes("disconnected")) {
          isPrinterConnected = false;
          updateConnectionStatus(false);
        }
      }
    }

    // Settings Modal - IMPROVED CATEGORY MANAGEMENT
    function showSettingsModal() {
      const settingsContent = document.getElementById('settings-content');
      
      const uniqueCategories = categories.filter(c => c !== 'all');
      
      const totalDigits = digitConfig.flex + digitConfig.category + digitConfig.product + digitConfig.weight;
      const isValid = totalDigits === 13;
      
      let categoryListHTML = '';
      if (uniqueCategories.length > 0) {
        uniqueCategories.forEach(cat => {
          categoryListHTML += `
            <div class="category-item">
              <span style="font-weight:500;">${cat}</span>
              <div class="category-actions">
                <button style="padding:5px 10px;border:none;border-radius:5px;background:#1D9BF0;color:white;font-size:12px;cursor:pointer;" 
                        onclick="editCategory('${cat}')">Edit</button>
                <button style="padding:5px 10px;border:none;border-radius:5px;background:#ff6b6b;color:white;font-size:12px;cursor:pointer;" 
                        onclick="deleteCategory('${cat}')">Hapus</button>
              </div>
            </div>
          `;
        });
      } else {
        categoryListHTML = '<div style="text-align:center;color:#999;padding:10px;">Belum ada kategori</div>';
      }
      
      settingsContent.innerHTML = `
        <div style="margin-bottom:20px;">
          <div style="color:#333;margin-bottom:10px;font-weight:600;font-size:1rem;">Konfigurasi Digit Barcode</div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
            <div>
              <div style="color:#333;margin-bottom:5px;font-weight:500;">Digit Flex</div>
              <input type="number" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;text-align:center;" 
                     id="flex-digits" value="${digitConfig.flex}" min="1" max="5">
            </div>
            <div>
              <div style="color:#333;margin-bottom:5px;font-weight:500;">Digit Kategori</div>
              <input type="number" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;text-align:center;" 
                     id="category-digits" value="${digitConfig.category}" min="1" max="5">
            </div>
            <div>
              <div style="color:#333;margin-bottom:5px;font-weight:500;">Digit Produk</div>
              <input type="number" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;text-align:center;" 
                     id="product-digits" value="${digitConfig.product}" min="1" max="5">
            </div>
            <div>
              <div style="color:#333;margin-bottom:5px;font-weight:500;">Digit Berat</div>
              <input type="number" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;text-align:center;" 
                     id="weight-digits" value="${digitConfig.weight}" min="1" max="5">
            </div>
          </div>
          
          <div class="digit-summary" style="background:${isValid ? '#DAE8F2' : '#ffe6e6'};border-color:${isValid ? '#A3D5D9' : '#ffcccc'};">
            <div style="font-weight:600;margin-bottom:5px;color:${isValid ? '#155724' : '#721c24'}">
              Total Digit: ${totalDigits}
            </div>
            <div style="font-size:0.9rem;color:${isValid ? '#155724' : '#721c24'}">
              ${isValid ? '‚úì Format barcode valid (13 digit)' : '‚ö† Harus tepat 13 digit!'}
            </div>
          </div>
        </div>
        
        <div style="margin-bottom:20px;">
          <div style="color:#333;margin-bottom:10px;font-weight:600;font-size:1rem;">Manajemen Kategori</div>
          <div style="background:#DAE8F2;padding:15px;border-radius:10px;margin-bottom:10px;">
            <div style="display:flex;gap:10px;margin-bottom:10px;">
              <input type="text" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:8px;" 
                     id="new-category-input-settings" placeholder="Nama kategori baru">
              <button style="padding:10px 15px;border:none;border-radius:8px;background:#1D9BF0;color:white;font-weight:600;cursor:pointer;" 
                      onclick="addNewCategoryFromSettings()">‚ûï Tambah</button>
            </div>
            
            <div style="max-height:200px;overflow-y:auto;margin-top:10px;" id="categories-list">
              ${categoryListHTML}
            </div>
          </div>
        </div>
        
        <div style="margin-bottom:20px;">
          <div style="color:#333;margin-bottom:10px;font-weight:600;font-size:1rem;">Manajemen Data</div>
          <button style="width:100%;padding:12px;border:none;border-radius:25px;background:#1D9BF0;color:white;font-weight:600;margin-bottom:10px;cursor:pointer;" 
                  onclick="exportData()">
            üì§ Export Data Produk
          </button>
          <button style="width:100%;padding:12px;border:none;border-radius:25px;background:#1D9BF0;color:white;font-weight:600;margin-bottom:10px;cursor:pointer;" 
                  onclick="importData()">
            üì• Import Data Produk
          </button>
          <button style="width:100%;padding:12px;border:none;border-radius:25px;background:#ff6b6b;color:white;font-weight:600;cursor:pointer;" 
                  onclick="clearAllData()">
            üóëÔ∏è Hapus Semua Data
          </button>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <button style="padding:14px;border:none;border-radius:25px;background:#A3D5D9;color:#333;font-weight:600;cursor:pointer;" 
                  onclick="closeSettingsModal()">BATAL</button>
          <button style="padding:14px;border:none;border-radius:25px;background:#1D9BF0;color:white;font-weight:600;cursor:pointer;" 
                  onclick="saveSettingsConfig()">SIMPAN</button>
        </div>
      `;
      
      const inputs = ['flex-digits', 'category-digits', 'product-digits', 'weight-digits'];
      inputs.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updateDigitSummary);
      });
      
      document.getElementById('settings-modal').style.display = 'flex';
    }

    // Add new category from settings
    function addNewCategoryFromSettings() {
      const input = document.getElementById('new-category-input-settings');
      const category = input.value.trim();
      
      if (!category) {
        showNotification('Masukkan nama kategori!', 'error');
        return;
      }
      
      if (categories.includes(category)) {
        showNotification('Kategori sudah ada!', 'error');
        return;
      }
      
      categories.push(category);
      saveCategories();
      renderCategories();
      showNotification(`Kategori "${category}" ditambahkan!`);
      input.value = '';
      
      // Refresh settings modal
      showSettingsModal();
    }

    function updateDigitSummary() {
      const flex = parseInt(document.getElementById('flex-digits').value) || 0;
      const category = parseInt(document.getElementById('category-digits').value) || 0;
      const product = parseInt(document.getElementById('product-digits').value) || 0;
      const weight = parseInt(document.getElementById('weight-digits').value) || 0;
      
      const total = flex + category + product + weight;
      const isValid = total === 13;
      const summary = document.querySelector('.digit-summary');
      
      if (summary) {
        summary.innerHTML = `
          <div style="font-weight:600;margin-bottom:5px;color:${isValid ? '#155724' : '#721c24'}">
            Total Digit: ${total}
          </div>
          <div style="font-size:0.9rem;color:${isValid ? '#155724' : '#721c24'}">
            ${isValid ? '‚úì Format barcode valid (13 digit)' : '‚ö† Harus tepat 13 digit!'}
          </div>
        `;
        summary.style.background = isValid ? '#DAE8F2' : '#ffe6e6';
        summary.style.borderColor = isValid ? '#A3D5D9' : '#ffcccc';
      }
    }

    function closeSettingsModal() {
      document.getElementById('settings-modal').style.display = 'none';
    }

    function saveSettingsConfig() {
      const flex = parseInt(document.getElementById('flex-digits').value) || 2;
      const category = parseInt(document.getElementById('category-digits').value) || 2;
      const product = parseInt(document.getElementById('product-digits').value) || 4;
      const weight = parseInt(document.getElementById('weight-digits').value) || 5;
      
      const total = flex + category + product + weight;
      
      if (total !== 13) {
        showNotification('Total digit harus 13!', 'error');
        return;
      }
      
      digitConfig = { flex, category, product, weight };
      saveSettings();
      
      showNotification('Pengaturan berhasil disimpan!');
      closeSettingsModal();
    }

    // Data Management
    function exportData() {
      const dataStr = JSON.stringify(products, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = `produk-data-${new Date().toISOString().split('T')[0]}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
      
      showNotification('Data berhasil diexport!');
    }

    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(event) {
          try {
            const importedData = JSON.parse(event.target.result);
            if (!Array.isArray(importedData)) {
              throw new Error('Format data tidak valid');
            }
            
            products = importedData;
            saveProducts();
            showNotification('Data berhasil diimport!');
          } catch (error) {
            showNotification('Gagal mengimport data: ' + error.message, 'error');
          }
        };
        reader.readAsText(file);
      };
      
      input.click();
    }

    function clearAllData() {
      if (confirm('Apakah Anda yakin ingin menghapus SEMUA data produk?')) {
        products = [];
        categories = ['all'];
        saveProducts();
        saveCategories();
        selectedCategory = 'all';
        renderCategories();
        renderProducts();
        showNotification('Semua data berhasil dihapus!');
        closeSettingsModal();
      }
    }

    // Notification System
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.background = type === 'error' ? '#ff6b6b' : '#1D9BF0';
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', initApp);
    
    // Close modals when clicking outside
    window.onclick = function(event) {
      if (event.target.classList.contains('modal-overlay')) {
        event.target.style.display = 'none';
        if (event.target.id === 'weight-modal') {
          currentProduct = null;
          weightValue = '';
          document.querySelectorAll('.product-card.selected').forEach(c => {
            c.classList.remove('selected');
          });
        } else if (event.target.id === 'product-modal') {
          editingProductId = null;
        } else if (event.target.id === 'settings-modal') {
          // Nothing special for settings
        }
      }
    };
  </script>
</body>
</html>
